#!/usr/bin/env bash

echo " Print ENV "
printenv | grep SLURM

# Benchmark info
echo "TIMING - Starting main script at: $(date)"

# Set working directory to home directory
cd "${HOME}"

# Workaround for directory permission error
# #unset XDG_RUNTIME_DIR
export XDG_RUNTIME_DIR=""

#
# Start Jupyter Notebook Server
#
# load the required conda module
module load anaconda

<%- unless context.conda_env.blank? -%>
#source /gpfs/runtime/opt/<#%=context.anaconda_module%>/etc/profile.d/conda.sh
conda activate <%=context.conda_env%>
<%- end -%>

<%- unless context.modules.blank? -%>
# Purge the module environment to avoid conflicts
module purge

# Update: psaluja (Sat-March9,2024)
# Bug reported by Liqi Shu and Paul Stey - When specifying a module to load (e.g., ffmpeg), 
# the Anaconda module fails to load, resulting in a 'Jupyter not found' error in the log.
# To maintain cleanliness, we purge the environment and reload Anaconda along with the essential requested modules.
module load anaconda

# Load the require modules
module load <%=context.modules%>

<%- end -%>

# Benchmark info
# List loaded modules
module list
echo "TIMING - Starting jupyter at: $(date)"

# Launch the Jupyter Notebook Server
set -x
jupyter <%= context.mode == "1" ? "lab" : "notebook" %> --config="${CONFIG_FILE}" <%= context.extra_jupyter_args %>